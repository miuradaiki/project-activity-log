# 日付跨ぎ記録編集エラー修正ログ

## 問題概要
**発生日時**: 2025-09-18  
**問題内容**: 「作業履歴」画面で日付を跨いだ記録を編集しようとすると「終了時間は開始時間より後である必要があります。」とエラーが発生し、更新ができない。

## 原因分析

### 根本原因
`ManualTimeEntryForm.tsx`のバリデーションロジックで、開始時間と終了時間を**同じ日付**で比較していたため、日跨ぎの場合に正常に処理できていませんでした。

```typescript
// 修正前の問題コード
const startDateTime = new Date(`${date}T${startTime}`);
const endDateTime = new Date(`${date}T${endTime}`); // 同じ日付を使用
const duration = endDateTime.getTime() - startDateTime.getTime();

if (duration <= 0) {
  alert('終了時間は開始時間より後である必要があります。');
  return;
}
```

### 具体的な問題例
- 開始時間: 2025-02-28 23:30
- 終了時間: 2025-03-01 01:30（翌日）

上記の場合、コードでは：
- startDateTime: 2025-02-28 23:30
- endDateTime: 2025-02-28 01:30（同日として解釈）

結果として`duration`がマイナスになり、エラーが発生していました。

## 実装した解決策

### 1. 終了日フィールドの追加
- 開始日(`startDate`)と終了日(`endDate`)を分離
- ユーザーが明示的に日跨ぎを指定可能

### 2. 日跨ぎ自動分割機能
- 日跨ぎ記録を日別に自動分割するオプションを追加
- チェックボックスで有効/無効を選択可能
- 分割時は各日のエントリーに連番を付与

### 3. 安全性の向上
- 24時間を超える記録の警告表示
- 異常に長時間の記録の確認ダイアログ
- 編集時の既存データ保護

### 4. UI改善
- 日跨ぎ時の情報表示（時間数・期間）
- カレンダーアイコン付きの日付フィールド
- 自動分割の説明テキスト

## 修正されたファイル

### 主要ファイル
1. **`/src/components/timer/ManualTimeEntryForm.tsx`**
   - 終了日フィールド追加
   - 日跨ぎ検証ロジック改善
   - 自動分割機能実装

2. **`/src/i18n/translations.ts`**
   - `timer.start.date`, `timer.end.date`キー追加

### 新機能
- **自動分割機能**: `createSplitEntries()`関数
- **日跨ぎ検知**: `isSameDay()`を使用した日付比較
- **時間警告**: 24時間超過時の確認ダイアログ

## テスト結果

### ビルドテスト
```bash
npm run build
# ✓ built in 5.36s (成功)
```

### 機能テスト
- [x] 新規作成での日跨ぎ記録
- [x] 既存記録の編集
- [x] 自動分割機能
- [x] 長時間記録警告
- [x] 多言語対応

## データ互換性

### 既存データへの影響
**✅ 影響なし**: 既存の`TimeEntry`データ構造は変更なし
- `startTime`, `endTime`は引き続きISO文字列で管理
- 既存の日跨ぎ記録も正常に表示・編集可能

### ストレージ構造
```typescript
// 変更なし
export interface TimeEntry {
  id: string;
  projectId: string;
  startTime: string;  // ISO string
  endTime: string;    // ISO string
  description: string;
  createdAt: string;
  updatedAt: string;
}
```

## リスク軽減措置

1. **編集時の安全処理**: 既存エントリー編集では分割機能を無効化
2. **確認ダイアログ**: 長時間記録の確認
3. **バックワード互換性**: 既存データ形式の完全維持

## 今後の改善点

1. **UI/UX向上**: 
   - 日跨ぎ入力のより直感的な操作
   - 分割プレビュー機能

2. **機能拡張**:
   - カスタム分割ルール（深夜0時以外での区切り）
   - 分割エントリーの関連付け表示

## 完了確認

- [x] 問題の根本原因特定
- [x] 解決策の実装
- [x] テスト実行
- [x] ドキュメント作成
- [x] データ互換性確認

**修正完了日時**: 2025-09-18  
**作業時間**: 約2時間  
**影響範囲**: ManualTimeEntryFormコンポーネント  
**データ影響**: なし（完全後方互換）
